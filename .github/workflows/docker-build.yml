# .github/workflows/docker-build-optimized.yml
name: Build Optimized Docker Image

on:
  workflow_dispatch:
  push:
    paths:
      - 'docker/**'
    branches: [ main ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Free up disk space
      run: |
        echo "=== Before cleanup ==="
        df -h
        
        # Remove unnecessary packages and files
        sudo apt-get remove -y \
          apache2-bin \
          firefox \
          google-chrome-stable \
          microsoft-edge-stable
        sudo apt-get autoremove -y
        sudo apt-get clean
        
        # Remove large directories
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf /usr/local/share/boost
        
        # Clean Docker
        docker system prune -af
        
        echo "=== After cleanup ==="
        df -h
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        driver-opts: |
          network=host
    
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: ./docker
        file: ./docker/Dockerfile
        platforms: linux/amd64
        push: true
        tags: ${{ secrets.DOCKERHUB_USERNAME }}/coqui-tts-xtts-v2:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          BUILDKIT_INLINE_CACHE=1